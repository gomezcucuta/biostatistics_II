---
title: "Taller de Regresion Lineal Multiple"
author: "G"
date: "August 26, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Pasos en el Analisis de Regresion

### Planteamiento del problema

En promedio, el numero de paquetes de cigarrilo vendidos en los Estados Unidos es menor por cada unidad que incremente el precio promedio ponderado de un paquete de cigarrillos, ajustado por la edad, la escolaridad, los ingresos, la raza, y el sexo.

### Selecion de las variables potencialmente relevantes

De acuerdo a una revision extensiva de la literatura, las variables que pudieran estar asociadas con el desenlace son:

**Variables independientes:**

Edad: Mediana de la edad de una persona que vive en determinado estado.

Escolaridad: Porcetaje de personas mayores de 25 a;os que completaron el bachillerato.

Ingresos: Ingreso per capita para un estado (ingresos en dolares)

Raza/etnia (afrodescendiente): Porcentaje de afrodescendientes que vive en determinado estado.

Sexo: Porcentaje de mujeres que vive en determinado estado.

Precio: Precio promedio ponderado (en centavos) de un paquete de cigarrillos en un estado.

**Variable dependiente:**

Ventas: Numero de paquetes de cigarrilo vendidos en un estado con base al ingreso per capita.

### Recoleccion de los datos

Datos de consumo de cigarrillo recolectados por una compania aseguradora norteamericana, los cuales corresponden a 50 estados y el distrito de Columbia en el a;o de 1970.  La base se encuentra disponible de manera gratuita en http://www1.aucegypt.edu/faculty/hadi/RABE4/

```{r}
# Limpiar el workspace

rm(list=ls())

# Especificar el directorio de trabajo

setwd("~/Dropbox/Education/UNAL/Biostatistics II/wd_for_biostats_II")

# Para cargar la base en el workspace y familiarizarse con ella:

load("CHP.Rdata")
ls()
str(P081)
head(P081)
```

### Especificacion del modelo

Teniendo en cuenta una funcion lineal, la ecuacion de la regresion multiple es:

$$Y = X \beta + \epsilon$$

O de manera equivalente:

$$Y = \beta_0 + \beta_1 X_1+ \beta_2 X_2 + \beta_3 X_3 + \beta_4 X_4 + \beta_5 X_5+ \beta_6 X_6 + \epsilon$$

### Metodo de ajuste

El metodo que se empleara para estimar los parametros sera el metodo de minimos cuadrados.

### Ajuste del modelo

```{r}
# Para especificar el modelo completo y ver el resultado:

fit <- lm(P081$Sales ~ P081$Price + P081$Age + P081$HS + P081$Income + P081$Black + P081$Female)

summary(fit)

anova(fit)
```

### Critica del modelo y seleccion

**Modelo completo**

$$\widehat{Ventas} = 103.34485 - 3.25492*Precio + 4.52045*Edad - 0.06159*Escolaridad + 0.01895*Ingresos + 0.35754*Raza/Etnia - 1.05286*Sexo$$

**Diagrama de dispersion y recta ajustada**

```{r}
# Como se hace???
```

**Diagnosticos del modelo**

```{r, fig = TRUE}
plot(fit)
```

**Modelo reducido con cinco variables predictoras**

De las seis vartiables predictoras, la variable escolaridad tiene el valor p mas alto (0.94008); por lo tanto, se decide removerla del modelo completo.

```{r}
# Modelo reducido: Sin la variable escolaridad.

fit <- lm(P081$Sales ~ P081$Price + P081$Age + P081$Income + P081$Black + P081$Female)

summary(fit)

anova(fit)
```

$$\widehat{Ventas} = 100.133255 - 3.243835*Precio + 4.593832*Edad + 0.018418*Ingresos + 0.379049*Raza/Etnia - 1.067115*Sexo$$

**Prueba de hipotesis para el modelo reducido 1 empleando la F**

Ho: El modelo reducido es adecuado.

Ha: El modelo completo es adecuado.

F = ((R^2^p - R^2^q) / (p - q)) / ((1 - R^2^p) / (n - p - 1))

F = ((0.3208 - 0.3208) / (6 - 5)) /  ((1 - 0.3208) / (51 - 6 - 1)) = 0

```{r}
qf(0.95, 1, 44)
```

**F < F(1, 44; 0.05)**

0 < 4.061706

```{r}
pf(0, 1, 44, lower.tail = FALSE)
```

**p(F) > alfa**

1 > 0.05

**Graficamente**

```{r, fig = TRUE}
curve(df(x, df1 = 1, df2 = 44), xlim = c(0, 5), las = 1)
abline(v = c(4.061706), col = "red")
abline(v = c(0), col = "blue")
```

Por lo tanto, no hay evidencia para rechazar la hipotesis nula.

**Diagnosticos del modelo**

```{r, fig = TRUE}
plot(fit)
```

**Modelo reducido con cuatro variables predictoras**

```{r}
# Modelo reducido: Sin las variables escolaridad y sexo.

fit <- lm(P081$Sales ~ P081$Price + P081$Age + P081$Income + P081$Black)

summary(fit)

anova(fit)
```

$$\widehat{Ventas} = 55.329580 - 3.239941*Precio + 4.191538*Edad + 0.018892*Ingresos + 0.334162*Raza/Etnia$$

**Prueba de hipotesis para el modelo reducido 2 empleando la F**

Ho: El modelo reducido es adecuado.

Ha: El modelo completo es adecuado.

F = ((R^2^p - R^2^q) / (p - q)) / ((1 - R^2^p) / (n - p - 1))

F = ((0.3208 - 0.3202) / (6 - 4)) /  ((1 - 0.3208) / (51 - 6 - 1)) = 0.01943463

```{r}
qf(0.95, 2, 44)
```

**F < F(2, 44; 0.05)**

0.01923858 < 3.209278

```{r}
pf(0.01943463, 2, 44, lower.tail = FALSE)
```

**p(F) > alfa**

0.9807614 > 0.05

**Graficamente**

```{r, fig = TRUE}
curve(df(x, df1 = 2, df2 = 44), xlim = c(0, 5), las = 1)
abline(v = c(3.209278), col = "red")
abline(v = c(0.01943463), col = "blue")
```

Por lo tanto, no hay evidencia para rechazar la hipotesis nula.

**Diagnosticos del modelo**

```{r, fig = TRUE}
plot(fit)
```

**Modelo reducido con tres variables predictoras**

```{r}
# Modelo reducido: Sin las variables escolaridad, sexo, y raza/etnia.
fit <- lm(P081$Sales ~ P081$Price + P081$Age + P081$Income)

summary(fit)

anova(fit)
```

$$\widehat{Ventas} = 64.248227 - 3.399234*Precio + 4.155909*Edad + 0.019281*Ingresos$$

**Prueba de hipotesis para el modelo reducido 3 empleando la F**

Ho: El modelo reducido es adecuado.

Ha: El modelo completo es adecuado.

F = ((R^2^p - R^2^q) / (p - q)) / ((1 - R^2^p) / (n - p - 1))

F = ((0.3208 - 0.3032) / (6 - 3)) /  ((1 - 0.3208) / (51 - 6 - 1)) = 0.380055

```{r}
qf(0.95, 3, 44)
```

**F < F(3, 44; 0.05)**
0.380055 < 2.816466

```{r}
pf(0.380055, 3, 44, lower.tail = FALSE)
```

**p(F) > alfa**
0.7678403 > 0.05

**Graficamente**

```{r, fig = TRUE}
curve(df(x, df1 = 3, df2 = 44), xlim = c(0, 5), las = 1)
abline(v = c(2.816466), col = "red")
abline(v = c(0.380055), col = "blue")
```

Por lo tanto, no hay evidencia para rechazar la hipotesis nula.

**Diagnosticos del modelo**

```{r, fig = TRUE}
plot(fit)
```

**Modelo reducido con dos variables predictoras**

```{r}
# Modelo reducido: Sin las variables escolaridad, sexo, raza/etnia, y edad.
fit <- lm(P081$Sales ~ P081$Price + P081$Income)

summary(fit)

anova(fit)
```

$$\widehat{Ventas} = 153.33841 - 3.01756*Precio + 0.02208*Ingresos$$

**Prueba de hipotesis para el modelo reducido 4 empleando la F**

Ho: El modelo reducido es adecuado.

Ha: El modelo completo es adecuado.

F = ((R^2^p - R^2^q) / (p - q)) / ((1 - R^2^p) / (n - p - 1))

F = ((0.3208 - 0.2503) / (6 - 2)) /  ((1 - 0.3208) / (51 - 6 - 1)) = 1.141784

```{r}
qf(0.95, 4, 44)
```

**F < F(4, 44; 0.05)**
1.141784 < 2.583667

```{r}
pf(2.283569, 4, 44, lower.tail = FALSE)
```

**p(F) > alfa**
0.07539178 > 0.05

**Graficamente**

```{r, fig = TRUE}
curve(df(x, df1 = 4, df2 = 44), xlim = c(0, 5), las = 1)
abline(v = c(2.583667), col = "red")
abline(v = c(1.141784), col = "blue")
```

Por lo tanto, no hay evidencia para rechazar la hipotesis nula.

**Diagnosticos del modelo**

```{r, fig = TRUE}
plot(fit)
```

### Objetivos del analisis de regresion